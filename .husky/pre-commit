#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. Security check: Look for hardcoded API keys
echo "ğŸ” Checking for hardcoded secrets..."
if grep -r "ntn_" src/ 2>/dev/null; then
  echo "âŒ ERROR: Found Notion token in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

if grep -r "sk-" src/ 2>/dev/null; then
  echo "âŒ ERROR: Found API key in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

if grep -r "eyJhbGciOiJ" src/ 2>/dev/null; then
  echo "âŒ ERROR: Found JWT token in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

echo "âœ… No hardcoded secrets found"

# 2. TypeScript type checking
echo "ğŸ”§ Running TypeScript type check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ ERROR: TypeScript type check failed!"
  echo "   Fix type errors before committing."
  exit 1
fi
echo "âœ… TypeScript check passed"

# 3. Linting
echo "ğŸ§¹ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ERROR: ESLint found issues!"
  echo "   Fix linting errors before committing."
  exit 1
fi
echo "âœ… Linting passed"

# 4. Format check
echo "ğŸ’… Checking code formatting..."
npm run format -- --check
if [ $? -ne 0 ]; then
  echo "âš ï¸  WARNING: Code is not formatted. Auto-formatting..."
  npm run format
  git add .
fi
echo "âœ… Formatting check passed"

# 5. Run tests
echo "ğŸ§ª Running tests..."
npm run test -- --run
if [ $? -ne 0 ]; then
  echo "âŒ ERROR: Tests failed!"
  echo "   Fix failing tests before committing."
  exit 1
fi
echo "âœ… Tests passed"

echo ""
echo "âœ¨ All pre-commit checks passed! Ready to commit."

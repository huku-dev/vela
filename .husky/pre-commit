#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# 1. Security check: Look for hardcoded API keys
echo "üîê Checking for hardcoded secrets..."
if grep -r "ntn_" src/ 2>/dev/null; then
  echo "‚ùå ERROR: Found Notion token in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

if grep -r "sk-" src/ 2>/dev/null; then
  echo "‚ùå ERROR: Found API key in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

if grep -r "eyJhbGciOiJ" src/ 2>/dev/null; then
  echo "‚ùå ERROR: Found JWT token in source code!"
  echo "   Remove hardcoded secrets and use environment variables."
  exit 1
fi

echo "‚úÖ No hardcoded secrets found"

# 2. TypeScript type checking
echo "üîß Running TypeScript type check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå ERROR: TypeScript type check failed!"
  echo "   Fix type errors before committing."
  exit 1
fi
echo "‚úÖ TypeScript check passed"

# 3. Linting
echo "üßπ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå ERROR: ESLint found issues!"
  echo "   Fix linting errors before committing."
  exit 1
fi
echo "‚úÖ Linting passed"

# 4. Format check
echo "üíÖ Checking code formatting..."
npm run format -- --check
if [ $? -ne 0 ]; then
  echo "‚ö†Ô∏è  WARNING: Code is not formatted. Auto-formatting..."
  npm run format
  git add .
fi
echo "‚úÖ Formatting check passed"

# 5. Run tests
echo "üß™ Running tests..."
npm run test -- --run
if [ $? -ne 0 ]; then
  echo "‚ùå ERROR: Tests failed!"
  echo "   Fix failing tests before committing."
  exit 1
fi
echo "‚úÖ Tests passed"

# 6. Signal Change Review (SCR) gate
# If signal logic files are modified, warn if no SCR document is in the commit.
# This is a soft gate (warning, not blocking) ‚Äî some changes are pure refactors.
SIGNAL_FILES_CHANGED=$(git diff --cached --name-only | grep -E "(signal-rules|signal-engine|signal-persistence)\.(ts|js)" || true)
if [ -n "$SIGNAL_FILES_CHANGED" ]; then
  SCR_FILES=$(git diff --cached --name-only | grep -E "docs/signal-reviews/SCR-" || true)
  if [ -z "$SCR_FILES" ]; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: Signal logic files are being modified:"
    echo "$SIGNAL_FILES_CHANGED" | sed 's/^/   /'
    echo ""
    echo "   No SCR document (docs/signal-reviews/SCR-*.md) found in this commit."
    echo "   Signal logic changes require a Signal Change Review before production."
    echo "   See: docs/signal-reviews/TEMPLATE.md"
    echo "   Run: python scripts/validate-signal-change.py --config-name <your_config>"
    echo ""
    echo "   Proceeding anyway (soft gate). Add an SCR doc before merging to main."
    echo ""
  else
    echo "‚úÖ SCR document found for signal logic change: $SCR_FILES"
  fi
fi

echo ""
echo "‚ú® All pre-commit checks passed! Ready to commit."
